<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>        
        *{
            margin: 0;
            padding: 0;
            box-sizing: border-box; /* Add this for better layout handling */
        }
        body{
            background-color: black;
            font-family: Arial, sans-serif; /* Add a generic font for better compatibility */
        }
        /* Show the video with the 'visible' class */   
        .youtube {
            width: 100%;
            height: 100vh;
        }  
    </style>
</head>
<body>  
    <div id="player" class="youtube visible"></div>

    <script>
        var playerId = 'KDL078L';
        var isAdvert = false;
        var initialId = "a_C2V3iNPbY";
        var currentId = '';
        var advertId = '';
        var player;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', // Use '100%' instead of 'fullscreen' for compatibility
                width: '100%',
                videoId: isAdvert ? advertId : (currentId.length > 0 ? currentId : initialId),
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function extractVideoId(url) {
            var regExp = /^(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            var match = url.match(regExp);
            return match ? match[1] : null;
        }

        function getVideoId() {
            fetch(`https://warm-journey-18609535df73.herokuapp.com/api/v1/matatu/get_content/${playerId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.url.media_url !== currentId) {
                    currentId = extractVideoId(data.url.media_url);
                    console.log(data.url.media_url);
                }
                console.log('No new content found');
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function changeBackendVideo() {
            fetch(`https://warm-journey-18609535df73.herokuapp.com/api/v1/matatu/play_next_content/${playerId}/`, {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                console.log(response.status, response.statusText);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function onPlayerReady(event) {
            event.target.playVideo();
        }

        function getAdvert() {
            fetch(`https://warm-journey-18609535df73.herokuapp.com/api/v1/adverts/advert_check/${playerId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data && data.link && data.type === 'video') {
                    isAdvert = true;
                    advertId = extractVideoId(data.link);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                var checkTimeInterval = setInterval(function() {                
                    var timeRemaining = player.getDuration() - player.getCurrentTime();
                    if (timeRemaining <= 1) {                    
                        if (currentId.length == 0) {
                            getVideoId();
                            getAdvert();
                        } else if (isAdvert) {
                            isAdvert = false;
                        }
                    } else if (timeRemaining <= 2) {
                        console.log('Video is about to end!');
                        changeBackendVideo();
                        clearInterval(checkTimeInterval);
                    }
                }, 1000);
            }
        }

        // Function to show a toast message
        function showToast(message, duration) {
            var toast = document.createElement('div');
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.backgroundColor = 'black';
            toast.style.color = 'white';
            toast.style.padding = '10px';
            toast.style.borderRadius = '5px';
            toast.style.zIndex = '1000';
            document.body.appendChild(toast);

            setTimeout(function() {
                document.body.removeChild(toast);
            }, duration);
        }

        showToast('YouTube video is playing!', 2000);
    </script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src= 
        "https://code.jquery.com/jquery-3.4.1.min.js"> 
    </script>
</body>
</html>
